<input type="checkbox" id="night">Night Notifications</input><br>
<input type="checkbox" id="dawn">Dawn Notifications</input><br>
<input type="checkbox" id="boss">Boss Notifications</input><br>
<input type="checkbox" id="event">Event Notifications</input><br>
<input type="checkbox" id="stone">Boonstone/Riftstone Notifications</input><br>
<button id="save">Save</button>
<button id="disable">Disable Notifications</button>

<script type="module">
	// import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
	import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-messaging.js"

	const NOTIFICATIONS_ENDPOINT = `https://tl-notifications.beemerwt.workers.dev`;
	const FIREBASE_PUBLIC_KEY = 'BFS3keQ352mCG46syS6J40qudaLb66czVzlpFC62SjOAkHbyBgDpmwH5VxSkL_lQww6YOOXuxtt0d4veD82-TWU';

	const STATUS_URL = "https://iid.googleapis.com/iid/info/<FCM_REGISTRATION_TOKEN>";
	const SUB_URL = "https://iid.googleapis.com/iid/v1:batchAdd";
	const UNSUB_URL = "https://iid.googleapis.com/iid/v1:batchRemove";
	const TOPIC_URL = "https://iid.googleapis.com/iid/v1/projects/tl-notifications-7457a/messages:send";

	function post(path, data) {
		return fetch(`${NOTIFICATIONS_ENDPOINT}${path}`, {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify(data),
		});
	}

	const nightCheckbox = document.getElementById('night');
	const dawnCheckbox = document.getElementById('dawn');
	const bossCheckbox = document.getElementById('boss');
	const eventCheckbox = document.getElementById('event');
	const stoneCheckbox = document.getElementById('stone');
	const saveButton = document.getElementById('save');
	const disableButton = document.getElementById('disable');

	const messaging = getMessaging();

	saveButton.addEventListener('click', async () => {
		const night = nightCheckbox.checked;
		const dawn = dawnCheckbox.checked;
		const boss = bossCheckbox.checked;
		const event = eventCheckbox.checked;
		const stone = stoneCheckbox.checked;
		console.log("Saving", { night, dawn, boss, event, stone });

		let token;
		if (Notification.permission !== 'granted') {
			const permission = await Notification.requestPermission();
			if (permission === 'granted') {
				console.log('Notification permission granted.');
				token = await getToken(messaging, { vapidKey: FIREBASE_PUBLIC_KEY });
			} else {
				console.log('Notification permission denied.');
			}
		}

		if (!token) {
			console.log("No notification token");
			return;
		}

		const response = await post(`/`, {
			notifications: true,
			token,
			night, dawn, boss, event, stone
		});
	});

	disableButton.addEventListener('click', async () => {
		if (Notification.permission !== 'granted') {
			console.log("User is not subbed to notifications");
			return;
		}

		// incase it hasn't already been fetched
		const token = await getToken(messaging, { vapidKey: FIREBASE_PUBLIC_KEY });
		const response = await post('/', {
			notifications: false,
			notificationToken,
		});
	});
</script>
